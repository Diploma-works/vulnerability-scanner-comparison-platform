import json

from aio_pika.abc import AbstractIncomingMessage

from common.models.common import ScanFinishedMessage
from common.services.AnalyzeService import AnalyzeService


class RabbitMessageHandler:
    def __init__(
            self,
            analyzer_service: AnalyzeService
    ) -> None:
        self.__analyzer_service = analyzer_service

    async def process_message(self, message: AbstractIncomingMessage) -> None:
        async with message.process():
            scan_info = ScanFinishedMessage.model_construct(**json.loads(message.body.decode()))
            print(f"processing scan {scan_info.scan_id}")
            await self.__analyzer_service.analyze_scan_report(scan_info.scan_id)

