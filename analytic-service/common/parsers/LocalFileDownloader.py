import os
from urllib.parse import unquote

from aioscrapy import Request, Spider
from aioscrapy.core.downloader.handlers import BaseDownloadHandler
from aioscrapy.http import HtmlResponse


class LocalFileDownloader(BaseDownloadHandler):

    async def download_request(self, request: Request, _: Spider) -> HtmlResponse:
        old = 'file:///' if os.name == 'nt' else 'file://'
        file_path = unquote(request.url, encoding='utf-8').replace(old, '')

        with open(file_path, mode='rb') as file:
            file_bytes = file.read()

        return HtmlResponse(
            url=request.url,
            body=file_bytes,
            encoding='utf-8'
        )

    async def close(self):
        pass
