import os

from fastapi import APIRouter
from fastapi.responses import JSONResponse
from yoyo import get_backend, read_migrations

from app.config import Config
from app.db.events import get_dsn

router = APIRouter(prefix="/system", tags=["system"])
config = Config()
migrations_path = os.path.join(config.project_path, config.db.migrations_path)


@router.get(
    path="/migrations",
    description="Возвращает список доступных миграций для применения",
)
async def get_available_migrations():
    backend = get_backend(get_dsn(config.db))
    migrations = read_migrations(migrations_path)
    migrations = backend.to_apply(migrations)
    return JSONResponse([i.id for i in migrations.items])


@router.post(
    path="/migrations/apply",
    description="Применяет доступные миграции",
)
async def apply_available_migrations():
    backend = get_backend(get_dsn(config.db))
    migrations = read_migrations(migrations_path)
    migrations_to_apply = backend.to_apply(migrations)
    backend.apply_migrations(migrations_to_apply)
    return JSONResponse([i.id for i in migrations_to_apply.items])
