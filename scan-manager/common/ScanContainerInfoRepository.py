from typing import List

from pypika import Table
from pypika.queries import QueryBuilder, Query

from app.db import BaseRepository
from common.models import ScanContainerInfo

scan_container_info = Table('scan_container_info')


class ScanContainerInfoRepository(BaseRepository):

    async def insert_scan_container_info(
            self,
            scan_id: int,
            container_id: str,
            exit_code: int
    ) -> None:
        q: QueryBuilder = Query().into(scan_container_info).columns(
            'scan_id', 'container_id', 'exit_code'
        ).insert(
            scan_id, container_id, exit_code
        )

        await self.execute(q)

    async def get_scan_container_info(self) -> List[ScanContainerInfo]:
        q: QueryBuilder = Query().from_(scan_container_info).select('*')
        return await self.fetch_rows(q, serializer=ScanContainerInfo)

    async def remove_scan_container_info(self, scan_id: int) -> None:
        q: QueryBuilder = Query().from_(scan_container_info).delete().where(scan_container_info.scan_id == scan_id)
        await self.execute(q)
